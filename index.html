<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EV Tools: Calculator & Converter</title> <!-- Updated Title -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#007bff">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f6f8;
      padding: 2em;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
      padding: 2em;
      max-width: 450px;
      width: 100%;
      box-sizing: border-box;
    }
    .card h2 { /* Main Title */
      margin-top: 0;
      margin-bottom: 1em; /* Reduced margin */
      text-align: center;
      color: #333;
    }
     /* Tab Styles */
    .tab-buttons {
        display: flex;
        border-bottom: 1px solid #ccc;
        margin-bottom: 1.5em; /* Space below tabs */
    }
    .tab-button {
        padding: 0.8em 1.2em;
        cursor: pointer;
        border: none;
        background-color: transparent;
        border-bottom: 3px solid transparent; /* Placeholder for active border */
        font-size: 1em;
        color: #555;
        transition: color 0.2s ease, border-bottom-color 0.2s ease;
    }
    .tab-button:hover {
        color: #0056b3;
    }
    .tab-button.active {
        color: #007bff;
        border-bottom-color: #007bff;
        font-weight: 600;
    }

    /* Tab Content Styles */
    .tab-content {
        display: none; /* Hide content by default */
    }
    .tab-content.active {
        display: block; /* Show active content */
    }

    /* General Form Styles (keep as is) */
    .form-group {
      margin-bottom: 1.2em;
    }
    label {
      display: block;
      margin-bottom: 0.5em;
      font-weight: 600;
      color: #555;
      font-size: 0.9em;
    }
    label[for="configPercent"] { color: #777; }
    input[type="number"], select {
      width: 100%;
      padding: 0.8em;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      font-size: 1em;
      transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    input[type="number"]:focus, select:focus {
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
      outline: none;
    }
    input[type="number"]:disabled, input[type="number"][readonly] {
        background-color: #e9ecef;
        cursor: not-allowed;
        opacity: 0.8;
    }
     input[type="number"][readonly] { cursor: default; }
    .input-row {
      display: flex;
      gap: 1em;
      align-items: flex-end;
    }
    .input-row .form-group { flex: 1; margin-bottom: 0; }

    /* Calculator Specific Styles (if any needed) */
    #calculator-content button { /* Style button within calculator */
      background: #007bff;
      color: white;
      border: none;
      padding: 0.8em 1.5em;
      border-radius: 8px;
      width: 100%;
      font-size: 1.1em;
      font-weight: 600;
      cursor: pointer;
      margin-top: 1.5em;
      transition: background-color 0.2s ease-in-out;
    }
    #calculator-content button:hover { background-color: #0056b3; }
    .result {
      margin-top: 2em;
      padding: 1.2em;
      background: #e9f7ef;
      border-left: 5px solid #28a745;
      border-radius: 8px;
      color: #155724;
      line-height: 1.6;
    }
    .result strong { color: #004085; }
    #startTimer {
      display: none;
      margin-top: 1em;
      background: #28a745;
    }
    #startTimer:hover { background-color: #1e7e34; }
    #timerDisplay {
      font-size: 1.5em;
      margin-top: 1em;
      text-align: center;
      font-weight: bold;
      color: #333;
    }
    #endTimeDisplay {
      font-size: 1em;
      margin-top: 0.5em;
      text-align: center;
      color: #555;
    }

    /* Converter Specific Styles */
    #converter-content h3 { /* Converter title */
      margin-top: 0; /* Reset top margin as it's inside tab now */
      margin-bottom: 1em;
      text-align: center;
      color: #555;
      /* border-top: 1px solid #eee; No longer needed */
      padding-top: 0; /* Reset padding */
    }
    #converter-content .form-group { margin-bottom: 0.8em; }
    #converter-content .input-row { margin-bottom: 0.8em; }
    #converter-content .converter-config label { font-size: 0.8em; }
     #converter-content hr { border: none; border-top: 1px dashed #ccc; margin: 1.5em 0; }
  </style>
</head>
<body>
  <div class="card">
    <h2>EV Tools</h2> <!-- More General Title -->

    <!-- Tab Buttons -->
    <div class="tab-buttons">
        <button class="tab-button active" data-tab-target="#calculator-content">Calculator</button>
        <button class="tab-button" data-tab-target="#converter-content">Converter</button>
    </div>

    <!-- Tab Content Panels -->
    <div id="calculator-content" class="tab-content active">
        <!-- ===== Calculator Section ===== -->
        <div class="form-group">
          <label for="battery">Vehicle Battery Size (kWh)</label>
          <input type="number" id="battery" min="1" value="54" step="0.1" />
        </div>

        <p style="font-size: 0.8em; color: #666; margin-top: -0.5em; margin-bottom: 1em;">Enter EITHER initial charge % OR initial kWh:</p>
        <div class="input-row">
          <div class="form-group">
            <label for="percent">Initial Charge (%)</label>
            <input type="number" id="percent" min="0" max="100" step="1" oninput="toggleInputs('percent')" />
          </div>
          <div class="form-group">
            <label for="kwh">Initial Charge (kWh)</label>
            <input type="number" id="kwh" min="0" step="0.1" oninput="toggleInputs('kwh')" />
          </div>
        </div>

        <div class="form-group" style="margin-top: 1.2em;">
          <label for="final">Target Charge (%)</label>
          <input type="number" id="final" min="1" max="100" value="80" step="1" />
        </div>

        <div class="form-group">
          <label for="charger">Charger Power (kW)</label>
          <input type="number" id="charger" min="0.1" step="0.1" placeholder="e.g., 7.4, 11, 50, 100" value="100" />
        </div>

        <button onclick="calculateTime()">Calculate Time</button>
        <button id="startTimer" onclick="startTimer()">Start Charging Timer</button>

        <div id="timerDisplay"></div>
        <div id="endTimeDisplay"></div>

        <div id="result" class="result" style="display: none;"></div>
        <!-- ===== End Calculator Section ===== -->
    </div>

    <div id="converter-content" class="tab-content">
        <!-- ===== Converter Section ===== -->
        <h3>Range / % / kWh Converter</h3>

        <p style="font-size: 0.8em; color: #666; margin-top: -1em; margin-bottom: 1em;">Configure your typical full range and the battery size for *this conversion*, then enter any *one* of the current values below.</p>

        <div class="converter-config">
             <div class="input-row">
                <div class="form-group">
                    <label for="configRange">Typical Range When Full</label>
                    <input type="number" id="configRange" min="1" value="400" step="1" />
                </div>
                 <div class="form-group" style="flex: 0 0 80px;">
                     <label for="rangeUnit">Units</label>
                     <select id="rangeUnit">
                         <option value="km" selected>km</option>
                         <option value="miles">miles</option>
                     </select>
                 </div>
             </div>
             <div class="input-row">
                 <div class="form-group">
                    <label for="configCapacity">Reference Battery Size (kWh)</label>
                    <input type="number" id="configCapacity" value="54" min="1" step="0.1" />
                 </div>
                 <div class="form-group" style="display: none;">
                    <label for="configPercent">Corresponding to (%)</label>
                    <input type="number" id="configPercent" value="100" min="1" max="100" step="1" readonly/>
                 </div>
            </div>
        </div>

        <hr>

        <div class="form-group">
            <label for="currentRange">Current Range (<span class="unit-label">km</span>)</label>
            <input type="number" id="currentRange" min="0" step="1" placeholder="e.g., 250" oninput="updateConverterValues('range')" />
        </div>
        <div class="form-group">
            <label for="currentPercent">Current Percentage (%)</label>
            <input type="number" id="currentPercent" min="0" max="100" step="1" placeholder="e.g., 60" oninput="updateConverterValues('percent')" />
        </div>
        <div class="form-group">
            <label for="currentKwh">Current Capacity (kWh)</label>
            <input type="number" id="currentKwh" min="0" step="0.1" placeholder="e.g., 32.4" oninput="updateConverterValues('kwh')" />
        </div>
        <!-- ===== End Converter Section ===== -->
    </div>

    <!-- Shared Elements (like audio) can remain outside tabs -->
    <audio id="alarmSound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>

  </div> <!-- End Card -->

  <script>
    // === Get Tab Elements ===
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    // === Tab Switching Logic ===
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetTab = button.dataset.tabTarget; // e.g., "#calculator-content"

            // Deactivate all tabs and content
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));

            // Activate the clicked tab and its content
            button.classList.add('active');
            document.querySelector(targetTab).classList.add('active');
        });
    });


    // === Original Calculator Variables ===
    let countdown;
    let endTime;
    let estimatedSeconds = 0;

    const batteryInput = document.getElementById('battery');
    const percentInput = document.getElementById('percent');
    const kwhInput = document.getElementById('kwh');
    const finalInput = document.getElementById('final');
    const chargerInput = document.getElementById('charger');
    const resultDiv = document.getElementById('result');
    const startTimerButton = document.getElementById('startTimer');
    const timerDisplay = document.getElementById('timerDisplay');
    const endTimeDisplay = document.getElementById('endTimeDisplay');
    const alarmSound = document.getElementById('alarmSound');

    // === Converter Variables ===
    const configRangeInput = document.getElementById('configRange');
    const rangeUnitSelect = document.getElementById('rangeUnit');
    const configCapacityInput = document.getElementById('configCapacity');
    const configPercentInput = document.getElementById('configPercent');
    const currentRangeInput = document.getElementById('currentRange');
    const currentPercentInput = document.getElementById('currentPercent');
    const currentKwhInput = document.getElementById('currentKwh');
    const unitLabels = document.querySelectorAll('.unit-label');


    // === Initialization and Event Listeners (Original Calculator) ===
    function updateCalculatorCapacityLimits() {
        const batterySize = parseFloat(batteryInput.value);
         if (!isNaN(batterySize) && batterySize > 0) {
            kwhInput.max = batterySize.toFixed(1);
            if (kwhInput.value !== '') {
               const currentKwh = parseFloat(kwhInput.value);
                if (!isNaN(currentKwh) && currentKwh > batterySize) {
                    kwhInput.value = batterySize.toFixed(1);
                     if (percentInput.disabled) { percentInput.value = 100; }
                }
            }
        } else { kwhInput.removeAttribute('max'); }
        if (kwhInput.disabled === false && percentInput.disabled === true && kwhInput.value !== '') {
            const currentKwh = parseFloat(kwhInput.value);
             if (!isNaN(currentKwh) && !isNaN(batterySize) && batterySize > 0 && currentKwh <= batterySize) {
                percentInput.value = ((currentKwh / batterySize) * 100).toFixed(0);
             }
        }
    }
    batteryInput.addEventListener('input', updateCalculatorCapacityLimits);

    function toggleInputs(source) { /* ... Keep previous toggleInputs logic ... */
        if (source === 'percent') {
            if (percentInput.value !== '') {
                kwhInput.disabled = true; kwhInput.value = ''; kwhInput.style.backgroundColor = '#e9ecef';
                percentInput.disabled = false; percentInput.style.backgroundColor = '';
                const batterySize = parseFloat(batteryInput.value); const percentVal = parseFloat(percentInput.value);
                if (!isNaN(batterySize) && !isNaN(percentVal) && batterySize > 0) {
                    kwhInput.disabled = false; kwhInput.value = (batterySize * (percentVal / 100)).toFixed(1); kwhInput.disabled = true;
                }
            } else { kwhInput.disabled = false; kwhInput.style.backgroundColor = ''; }
        } else if (source === 'kwh') {
            if (kwhInput.value !== '') {
                percentInput.disabled = true; percentInput.value = ''; percentInput.style.backgroundColor = '#e9ecef';
                kwhInput.disabled = false; kwhInput.style.backgroundColor = '';
                const batterySize = parseFloat(batteryInput.value); const kwhVal = parseFloat(kwhInput.value);
                if (!isNaN(batterySize) && !isNaN(kwhVal) && batterySize > 0) {
                    if (kwhVal > batterySize) {
                        kwhInput.value = batterySize.toFixed(1);
                        percentInput.disabled = false; percentInput.value = 100; percentInput.disabled = true;
                    } else {
                        percentInput.disabled = false; percentInput.value = ((kwhVal / batterySize) * 100).toFixed(0); percentInput.disabled = true;
                    }
                }
            } else { percentInput.disabled = false; percentInput.style.backgroundColor = ''; }
        }
    }

    function calculateTime() { /* ... Keep previous calculateTime logic ... */
        clearInterval(countdown); timerDisplay.innerHTML = ''; endTimeDisplay.innerHTML = ''; startTimerButton.style.display = 'none';
        const battery = parseFloat(batteryInput.value); const percent = parseFloat(percentInput.value); const kwh = parseFloat(kwhInput.value); const finalPercent = parseFloat(finalInput.value); let charger = parseFloat(chargerInput.value);
        if (isNaN(battery) || battery <= 0) { alert("Please enter a valid positive Vehicle Battery Size (kWh) for the calculator."); batteryInput.focus(); return; }
        let initial_kwh; let initial_percent_calc;
        if (!percentInput.disabled && !isNaN(percent)) { if (percent < 0 || percent > 100) { alert("Initial Charge Percentage must be between 0 and 100."); percentInput.focus(); return; } initial_kwh = battery * (percent / 100); initial_percent_calc = percent; }
        else if (!kwhInput.disabled && !isNaN(kwh)) { if (kwh < 0) { alert("Initial Charge kWh cannot be negative."); kwhInput.focus(); return; } if (kwh > battery) { alert(`Initial Charge kWh (${kwh.toFixed(1)}) cannot exceed vehicle battery size (${battery.toFixed(1)} kWh). It has been adjusted.`); kwhInput.value = battery.toFixed(1); initial_kwh = battery; } else { initial_kwh = kwh; } initial_percent_calc = (initial_kwh / battery) * 100; }
        else { if (percentInput.disabled === false && kwhInput.disabled === false && isNaN(percent) && isNaN(kwh)) { alert("Please provide either the Initial Charge Percentage or Initial Charge kWh."); percentInput.focus(); return; } else if (isNaN(percent) && !isNaN(kwh)) { percentInput.disabled = false; percentInput.style.backgroundColor = ''; alert("Initial percentage was cleared, please re-enter initial charge."); return; } else if (!isNaN(percent) && isNaN(kwh)) { kwhInput.disabled = false; kwhInput.style.backgroundColor = ''; alert("Initial kWh was cleared, please re-enter initial charge."); return; } else { alert("Please provide a valid Initial Charge Percentage or Initial Charge kWh."); return; } }
        if (isNaN(finalPercent) || finalPercent < 0 || finalPercent > 100) { alert("Target Charge Percentage must be between 0 and 100."); finalInput.focus(); return; }
        if (finalPercent < initial_percent_calc) { alert(`Target Charge (${finalPercent}%) cannot be lower than Initial Charge (${initial_percent_calc.toFixed(0)}%).`); finalInput.focus(); return; }
        if (isNaN(charger) || charger <= 0) { alert("Please enter a valid positive Charger Power (kW). Using default 100 kW."); charger = 100; chargerInput.value = 100; }
        const final_kwh = battery * (finalPercent / 100); const needed_kwh = final_kwh - initial_kwh;
        if (needed_kwh <= 0) { resultDiv.style.display = 'block'; resultDiv.innerHTML = `✅ Already at or above target charge! No charging needed.`; return; }
        const hours = needed_kwh / charger; estimatedSeconds = Math.round(hours * 60 * 60); const estimatedMinutes = Math.round(hours * 60);
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `<strong>📊 Charging Estimate:</strong><br />Vehicle Battery Size: ${battery.toFixed(1)} kWh<br />Initial Charge: ${initial_kwh.toFixed(1)} kWh (${initial_percent_calc.toFixed(0)}%)<br />Target Charge: ${final_kwh.toFixed(1)} kWh (${finalPercent.toFixed(0)}%)<br />Energy Needed: ${needed_kwh.toFixed(1)} kWh<br />Charger Power: ${charger.toFixed(1)} kW<br /><hr style="border: none; border-top: 1px solid #ccc; margin: 0.5em 0;"><strong>⏱️ Estimated Time: ${estimatedMinutes} minutes</strong>${estimatedMinutes > 60 ? ` (approx. ${Math.floor(estimatedMinutes / 60)}h ${estimatedMinutes % 60}m)` : ''}`;
        if (estimatedSeconds > 0) { startTimerButton.style.display = 'block'; }
    }

    function formatTime(date) { /* ... Keep previous formatTime logic ... */
        const hours = date.getHours(); const minutes = date.getMinutes(); const ampm = hours >= 12 ? 'PM' : 'AM'; const formattedHours = hours % 12 || 12; const formattedMinutes = minutes < 10 ? '0' + minutes : minutes; return `${formattedHours}:${formattedMinutes} ${ampm}`;
    }

    function startTimer() { /* ... Keep previous startTimer logic ... */
        if (estimatedSeconds <= 0) return; clearInterval(countdown); let timeLeft = estimatedSeconds; endTime = new Date(); endTime.setSeconds(endTime.getSeconds() + timeLeft); endTimeDisplay.innerHTML = `🏁 Expected completion: ${formatTime(endTime)}`;
        countdown = setInterval(() => { timeLeft--; if (timeLeft < 0) { clearInterval(countdown); timerDisplay.innerHTML = "✅ Charging Complete!"; endTimeDisplay.innerHTML = `Finished at ${formatTime(new Date())}`; const playPromise = alarmSound.play(); if (playPromise !== undefined) { playPromise.catch(error => { console.warn("Audio playback failed.", error); timerDisplay.innerHTML = "✅ Charging Complete! (Check sound)"; }); } return; } const hours = Math.floor(timeLeft / 3600); const minutes = Math.floor((timeLeft % 3600) / 60); const seconds = timeLeft % 60; let timeString = `⏳ `; if (hours > 0) { timeString += `${hours}h `; } timeString += `${minutes}m ${seconds < 10 ? '0' : ''}${seconds}s`; timerDisplay.innerHTML = timeString + " remaining"; }, 1000);
    }

    // === Converter Functions ===
    function updateUnitLabels() { /* ... Keep previous updateUnitLabels logic ... */
         const selectedUnit = rangeUnitSelect.value; unitLabels.forEach(label => { label.textContent = selectedUnit; });
    }

    function debounce(func, wait) { /* ... Keep previous debounce logic ... */
        let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); };
    }

    const debouncedUpdate = debounce(function(source) { /* ... Keep previous debouncedUpdate logic ... */
        const configRange = parseFloat(configRangeInput.value); const configCapacity = parseFloat(configCapacityInput.value); const configPercent = parseFloat(configPercentInput.value);
        if (isNaN(configRange) || configRange <= 0 || isNaN(configCapacity) || configCapacity <= 0 || isNaN(configPercent) || configPercent <= 0) { console.warn("Converter configuration invalid."); return; }
        const currentRange = parseFloat(currentRangeInput.value); const currentPercent = parseFloat(currentPercentInput.value); const currentKwh = parseFloat(currentKwhInput.value);
        let calculatedRange = currentRange; let calculatedPercent = currentPercent; let calculatedKwh = currentKwh;
        try {
            if (source === 'range' && !isNaN(currentRange)) { if (currentRange < 0) calculatedRange = 0; calculatedPercent = (calculatedRange / configRange) * configPercent; calculatedKwh = (calculatedRange / configRange) * configCapacity; }
            else if (source === 'percent' && !isNaN(currentPercent)) { if (currentPercent < 0) calculatedPercent = 0; if (currentPercent > 100) calculatedPercent = 100; calculatedKwh = configCapacity * (calculatedPercent / configPercent); calculatedRange = (calculatedPercent / configPercent) * configRange; }
            else if (source === 'kwh' && !isNaN(currentKwh)) { if (currentKwh < 0) calculatedKwh = 0; if (currentKwh > configCapacity) calculatedKwh = configCapacity; calculatedPercent = (calculatedKwh / configCapacity) * configPercent; calculatedRange = (calculatedKwh / configCapacity) * configRange; }
            else { if (source === 'range' && currentRangeInput.value === '') { currentPercentInput.value = ''; currentKwhInput.value = ''; } if (source === 'percent' && currentPercentInput.value === '') { currentRangeInput.value = ''; currentKwhInput.value = ''; } if (source === 'kwh' && currentKwhInput.value === '') { currentRangeInput.value = ''; currentPercentInput.value = ''; } return; }
            if (source !== 'range') { currentRangeInput.value = calculatedRange >= 0 ? calculatedRange.toFixed(0) : ''; }
            if (source !== 'percent') { currentPercentInput.value = calculatedPercent >= 0 ? calculatedPercent.toFixed(0) : ''; if (parseFloat(currentPercentInput.value) > 100) currentPercentInput.value = 100; }
            if (source !== 'kwh') { currentKwhInput.value = calculatedKwh >= 0 ? calculatedKwh.toFixed(1) : ''; }
        } catch (error) { console.error("Error during conversion calculation:", error); }
    }, 250);

    function updateConverterValues(source) { debouncedUpdate(source); }

    function handleConverterConfigChange() { /* ... Keep previous handleConverterConfigChange logic ... */
        const configCapacity = parseFloat(configCapacityInput.value);
        if (!isNaN(configCapacity) && configCapacity > 0) { currentKwhInput.max = configCapacity.toFixed(1); if (currentKwhInput.value !== '') { const currentKwhVal = parseFloat(currentKwhInput.value); if (!isNaN(currentKwhVal) && currentKwhVal > configCapacity) { currentKwhInput.value = configCapacity.toFixed(1); } } }
        else { currentKwhInput.removeAttribute('max'); }
        currentRangeInput.value = ''; currentPercentInput.value = ''; currentKwhInput.value = '';
    }

    // === Event Listeners (Converter) ===
    rangeUnitSelect.addEventListener('change', updateUnitLabels);
    configRangeInput.addEventListener('input', handleConverterConfigChange);
    configCapacityInput.addEventListener('input', handleConverterConfigChange);

    // === Initialization ===
    updateCalculatorCapacityLimits();
    handleConverterConfigChange();
    updateUnitLabels();

     // === PWA Service Worker Registration ===
    if ('serviceWorker' in navigator) { /* ... Keep previous PWA registration logic ... */
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => { console.log('SW registered: ', registration.scope); })
          .catch(error => { console.log('SW registration failed: ', error); });
      });
    }

  </script>
</body>
</html>